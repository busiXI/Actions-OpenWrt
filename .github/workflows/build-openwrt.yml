name: WR802N-v1 Custom Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Checkout project repo
      uses: actions/checkout@v4

    - name: Clone OpenWrt source
      run: |
        git clone --depth=1 https://git.openwrt.org/openwrt/openwrt.git -b v22.03.5 openwrt-src

    - name: Setup Python environment
      run: |
        # 修复系统Python限制
        sudo apt-get update
        sudo apt-get install -y \
          python3 \
          python3-pip \
          python3-venv \
          python3-dev

        # 创建专用虚拟环境
        python3 -m venv ~/openwrt-env
        source ~/openwrt-env/bin/activate
        pip install wheel setuptools

    - name: Install build dependencies
      run: |
        sudo apt-get install -y \
          build-essential \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          g++-multilib \
          gettext \
          git \
          libncurses-dev \
          libssl-dev \
          rsync \
          unzip \
          zlib1g-dev \
          file \
          wget

    - name: Apply configurations
      run: |
        # 确保使用虚拟环境
        source ~/openwrt-env/bin/activate
        # 复制配置文件
        cp .config openwrt-src/
        # 应用设备树修改
        sed -i 's/<0x50000 0x7a0000>/<0x50000 0x3c00000>/' \
          openwrt-src/target/linux/ar71xx/dts/ar9331_tl-wr802n-v1.dts

    - name: Initialize feeds
      run: |
        cd openwrt-src
        source ~/openwrt-env/bin/activate
        echo 'src-git tailscale https://github.com/tailscale/openwrt-tailscale.git' >> feeds.conf.default
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Build firmware
      run: |
        cd openwrt-src
        source ~/openwrt-env/bin/activate
        make defconfig
        make -j$(($(nproc) + 1)) V=s

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: wr802n-v1-firmware
        path: openwrt-src/bin/targets/ar71xx/generic/openwrt-*-tl-wr802n-v1-squashfs-sysupgrade.bin
